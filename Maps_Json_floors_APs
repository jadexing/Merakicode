"""
This script pulls AutoLocate job statuses and device data for a Meraki organization, 
and saves the JSON data locally for later use. It does not visualize the data, but 
provides the foundation for merging floor plan info with AP locations in subsequent processing.
Provides Json floor data and Json AP loc.
"""

import os
import json
import requests
from datetime import datetime

BASE_URL = "https://api.meraki.com/api/v1"


def get_api_key():
    """Prompt user for API key"""
    return input("Enter your Meraki Dashboard API key: ").strip()


def get_organization_id(api_key):
    """Get organization ID (auto-selects if only one)"""
    headers = {"X-Cisco-Meraki-API-Key": api_key}
    try:
        response = requests.get(f"{BASE_URL}/organizations", headers=headers)
        response.raise_for_status()
        orgs = response.json()
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error retrieving organizations: {e}")
        return None

    if not orgs:
        print("‚ùå No organizations found.")
        return None

    if len(orgs) == 1:
        org = orgs[0]
        print(f"‚úÖ Only one organization found: {org['name']} (ID: {org['id']})")
        return org["id"]

    print("\nOrganizations:")
    for i, org in enumerate(orgs, start=1):
        print(f"{i}. {org['name']} (ID: {org['id']})")

    choice = input("\nSelect organization number: ").strip()
    try:
        return orgs[int(choice) - 1]["id"]
    except (ValueError, IndexError):
        print("‚ùå Invalid choice.")
        return None


def fetch_api_data(api_key, org_id, endpoint):
    """Generic API fetcher"""
    headers = {"X-Cisco-Meraki-API-Key": api_key}
    url = f"{BASE_URL}/organizations/{org_id}/{endpoint}"
    print(f"üì° Fetching: {url}")
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error fetching data from {endpoint}: {e}")
        return None


def save_to_file(data, filename_prefix):
    """Save data into LocData folder"""
    os.makedirs("LocData", exist_ok=True)
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = os.path.join("LocData", f"{filename_prefix}_{timestamp}.json")
    try:
        with open(filename, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=4)
        print(f"‚úÖ Data saved to: {filename}")
    except Exception as e:
        print(f"‚ùå Error saving {filename_prefix} file: {e}")


def main():
    print("üõ∞Ô∏è Meraki AutoLocate Data Collector\n")

    api_key = get_api_key()
    if not api_key:
        print("‚ùå API key is required.")
        return

    org_id = get_organization_id(api_key)
    if not org_id:
        return

    # Fetch AutoLocate Statuses
    statuses = fetch_api_data(api_key, org_id, "floorPlans/autoLocate/statuses")
    if statuses is not None:
        save_to_file(statuses, "APdata")
    else:
        print("‚ö†Ô∏è No data retrieved for AutoLocate statuses.")

    # Fetch AutoLocate Devices
    devices = fetch_api_data(api_key, org_id, "floorPlans/autoLocate/devices")
    if devices is not None:
        save_to_file(devices, "LocData")
    else:
        print("‚ö†Ô∏è No data retrieved for AutoLocate devices.")

    print("\n‚úÖ Finished! Check the 'LocData' folder for your files.")


if __name__ == "__main__":
    main()
