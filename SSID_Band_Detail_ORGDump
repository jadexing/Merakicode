import requests
import time
from time import sleep
from openpyxl import Workbook

# ---------------------------------------
# CONFIGURABLE SETTINGS
# ---------------------------------------
REQUEST_TIMEOUT = 20          # seconds before a single request times out
RETRY_COUNT = 5               # how many times to retry a failed request
RETRY_BACKOFF = 3             # seconds to wait between retries
# ---------------------------------------

def meraki_get(url, api_key):
    """Robust GET with timeout, retries, and backoff."""
    headers = {
        "X-Cisco-Meraki-API-Key": api_key,
        "Content-Type": "application/json",
        "Accept": "application/json"
    }

    for attempt in range(1, RETRY_COUNT + 1):
        try:
            resp = requests.get(url, headers=headers, timeout=REQUEST_TIMEOUT)

            if resp.status_code in (204, 404):
                return None

            resp.raise_for_status()
            return resp.json()

        except requests.exceptions.Timeout:
            print(f"    ⚠ Timeout on attempt {attempt}/{RETRY_COUNT}. Retrying in {RETRY_BACKOFF}s...")
            sleep(RETRY_BACKOFF)

        except requests.exceptions.RequestException as e:
            print(f"    ⚠ Request error: {e}. Retrying in {RETRY_BACKOFF}s...")
            sleep(RETRY_BACKOFF)

    print("    ❌ Failed after maximum retries.")
    return None


def main():

    start_time = time.time()

    print("Hello! Welcome to this script that will display Meraki AP radio information.")
    print("This script will:")
    print(" • Ask for your API key")
    print(" • Pull ALL organizations tied to your API key")
    print(" • Pull ALL networks in each organization")
    print(" • Pull ALL APs in each network")
    print(" • Use /wireless/status to display full radio details")
    print(" • Export all results to a single Excel file with one tab per network")
    print(" • Handle timeouts and retry automatically\n")

    api_key = input("Please enter your API key: ").strip()

    # Create Excel workbook
    wb = Workbook()
    wb.remove(wb.active)  # Remove default sheet

    print("\nPulling your organizations...")
    orgs = meraki_get("https://api.meraki.com/api/v1/organizations", api_key)

    if not orgs:
        print("No organizations found for this API key.")
        return

    print(f"Found {len(orgs)} organizations.\n")

    # ⭐ Loop through ALL organizations
    for org in orgs:
        org_id = org["id"]
        org_name = org["name"]

        print(f"\n=== Processing Organization: {org_name} ({org_id}) ===\n")

        print("Pulling networks...")
        networks = meraki_get(
            f"https://api.meraki.com/api/v1/organizations/{org_id}/networks",
            api_key
        )

        if not networks:
            print("No networks found in this organization.\n")
            continue

        print(f"Found {len(networks)} networks.\n")
        print("Starting AP radio scan using /wireless/status\n")

        # ⭐ Loop through ALL networks in this org
        for net in networks:
            network_id = net["id"]
            network_name = net["name"]

            print(f"=== Network: {network_name} ({network_id}) ===")

            # Create a sheet for this network
            safe_name = network_name[:31]  # Excel sheet name limit
            ws = wb.create_sheet(title=safe_name)

            # Write header row
            ws.append([
                "AP Name",
                "Serial",
                "Model",
                "SSID",
                "Band",
                "Channel",
                "Channel Width",
                "Power",
                "BSSID",
                "Visible",
                "Broadcasting"
            ])

            devices = meraki_get(
                f"https://api.meraki.com/api/v1/networks/{network_id}/devices",
                api_key
            )

            if not devices:
                print("  No devices found.\n")
                continue

            aps = [d for d in devices if d.get("model", "").startswith(("MR", "CW"))]
            print(f"  Found {len(aps)} APs.\n")

            for ap in aps:
                name = ap.get("name", "Unnamed AP")
                serial = ap["serial"]
                model = ap.get("model", "")

                print(f"  Checking AP: {name} ({serial}) — Model {model}")

                status = meraki_get(
                    f"https://api.meraki.com/api/v1/networks/{network_id}/devices/{serial}/wireless/status",
                    api_key
                )

                if not status:
                    print("    No wireless status returned.\n")
                    continue

                bss_list = status.get("basicServiceSets", [])

                if not bss_list:
                    print("    No basicServiceSets found.\n")
                    continue

                for bss in bss_list:
                    ssid = bss.get("ssidName")
                    band = bss.get("band")
                    channel = bss.get("channel")
                    width = bss.get("channelWidth")
                    power = bss.get("power")
                    bssid = bss.get("bssid")
                    visible = bss.get("visible")
                    broadcasting = bss.get("broadcasting")

                    print(f"    SSID: {ssid}")
                    print(f"      Band: {band}")
                    print(f"      Channel: {channel}")
                    print(f"      Channel Width: {width}")
                    print(f"      Power: {power}")
                    print(f"      BSSID: {bssid}")
                    print(f"      Visible: {visible}")
                    print(f"      Broadcasting: {broadcasting}\n")

                    # Write to Excel sheet
                    ws.append([
                        name,
                        serial,
                        model,
                        ssid,
                        band,
                        channel,
                        width,
                        power,
                        bssid,
                        visible,
                        broadcasting
                    ])

            print()

    # Save Excel file
    filename = "ap_radio_export.xlsx"
    wb.save(filename)

    # Calculate runtime
    end_time = time.time()
    elapsed = end_time - start_time

    hours = int(elapsed // 3600)
    minutes = int((elapsed % 3600) // 60)
    seconds = int(elapsed % 60)

    print("All organizations and networks processed. Thank you for using this script!")
    print(f"Excel export saved as {filename}")
    print(f"Total runtime: {hours}h {minutes}m {seconds}s\n")


if __name__ == "__main__":
    main()
